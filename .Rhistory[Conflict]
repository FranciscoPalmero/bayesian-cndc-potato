f.get.W <- function(){
f.get.W_sh <- function(){
cols_W_sh <- c("D","E","F","G")
d_W_sh <- data %>%
select(match(cols_W_sh, ExcelLetters)) %>%
slice(rows)
colnames(d_W_sh) <- n_rate
d_W_sh <- d_W_sh %>%
mutate(dap=dap,
year=year,
variety=variety,
study=study,
location=location) %>%
mutate_all(as.character) %>%
pivot_longer(names_to="n_rate",
values_to="W_sh", #measure
cols=seq(1:length(cols_W_sh))) %>%
mutate(year=str_sub(year,1L,4L)) %>%
mutate(Date=ymd(paste(year,"01-01",sep="-"))) %>%
mutate(Date=Date+as.numeric(dap)) %>%
select(-c(dap,year)) %>%
select(study,location,variety,n_rate,Date,W_sh)
return(d_W_sh)
}
f.get.W_t <- function(){
cols_W_t <- c("S","T","U","V")
d_W_t <- data %>%
select(match(cols_W_t, ExcelLetters)) %>%
slice(rows)
colnames(d_W_t) <- n_rate
d_W_t <- d_W_t %>%
mutate(dap=dap,
year=year,
variety=variety,
study=study,
location=location) %>%
mutate_all(as.character) %>%
pivot_longer(names_to="n_rate",
values_to="W_t", #measure
cols=seq(1:length(cols_W_t))) %>%
mutate(year=str_sub(year,1L,4L)) %>%
mutate(Date=ymd(paste(year,"01-01",sep="-"))) %>%
mutate(Date=Date+as.numeric(dap)) %>%
select(-c(dap,year)) %>%
select(study,location,variety,n_rate,Date,W_t)
return(d_W_t)
}
W_sh <- f.get.W_sh()
W_t <- f.get.W_t()
W <- bind_cols(W_sh,
W_t %>% select(W_t))
return(W)
}
f.get.N <- function(){
f.get.N_sh <- function(){
cols_N_sh <- c("I","J","K","L")
d_N_sh <- data %>%
select(match(cols_N_sh, ExcelLetters)) %>%
slice(rows)
colnames(d_N_sh) <- n_rate
d_N_sh <- d_N_sh %>%
mutate(dap=dap,
year=year,
variety=variety,
study=study,
location=location) %>%
mutate_all(as.character) %>%
pivot_longer(names_to="n_rate",
values_to="N_sh", #measure
cols=seq(1:length(cols_N_sh))) %>%
mutate(year=str_sub(year,1L,4L)) %>%
mutate(Date=ymd(paste(year,"01-01",sep="-"))) %>%
mutate(Date=Date+as.numeric(dap)) %>%
select(-c(dap,year)) %>%
select(study,location,variety,n_rate,Date,N_sh)
return(d_N_sh)
}
f.get.N_t <- function(){
cols_N_t <- c("X","Y","Z","AA")
d_N_t <- data %>%
select(match(cols_N_t, ExcelLetters)) %>%
slice(rows)
colnames(d_N_t) <- n_rate
d_N_t <- d_N_t %>%
mutate(dap=dap,
year=year,
variety=variety,
study=study,
location=location) %>%
mutate_all(as.character) %>%
pivot_longer(names_to="n_rate",
values_to="N_t", #measure
cols=seq(1:length(cols_N_t))) %>%
mutate(year=str_sub(year,1L,4L)) %>%
mutate(Date=ymd(paste(year,"01-01",sep="-"))) %>%
mutate(Date=Date+as.numeric(dap)) %>%
select(-c(dap,year)) %>%
select(study,location,variety,n_rate,Date,N_t)
return(d_N_t)
}
N_sh <- f.get.N_sh()
N_t <- f.get.N_t()
N <- bind_cols(N_sh,
N_t %>% select(N_t))
return(N)
}
d <- bind_cols(f.get.W(),
f.get.N() %>% select(N_sh,N_t)) %>%
mutate_at(vars(W_sh,W_t,N_sh,N_t),as.numeric) %>%
rowwise() %>%
mutate(W=sum(W_sh,W_t,na.rm=T)) %>%
mutate(N=sum(W_sh*N_sh,W_t*N_t,na.rm=T)/W) %>%
ungroup() %>%
mutate(N=round(N,1)) %>%
rename(rate_n_kgha=n_rate) %>%
mutate_at(vars(rate_n_kgha),as.numeric) %>%
select(study,location,variety,rate_n_kgha,Date,W,N)
return(d)
}
f.get.list <- function(){
bind_rows(
tibble(
data = list("appendix_a"),
rows = list(c(4:8),c(9:12),c(13:17),c(18:22)),
n_rate = list(c("0","80","150","250")),
dap = list(c(45,60,75,90,110),c(55,61,83,110),c(47,62,75,91,105),c(45,58,74,95,116)),
year = list("2003-04","2004-05","2005-06","2006-07"),
variety = list("Innovator"),
location = list("Argentina"),
study = list("Giletto")
),
tibble(
data = list("appendix_a"),
rows = list(c(23:27),c(28:31),c(32:36),c(37:41)),
n_rate = list(c("0","80","150","250")),
dap = list(c(45,60,75,90,110),c(55,61,83,110),c(47,62,75,91,105),c(45,58,74,95,116)),
year = list("2003-04","2004-05","2005-06","2006-07"),
variety = list("Gem Russet"),
location = list("Argentina"),
study = list("Giletto")
),
tibble(
data = list("appendix_a"),
rows = list(c(42:45),c(46:50),c(51:55)),
n_rate = list(c("0","80","150","250")),
dap = list(c(55,61,83,110),c(47,62,75,91,105),c(45,58,74,95,116)),
year = list("2004-05","2005-06","2006-07"),
variety = list("Umatilla Russet"),
location = list("Argentina"),
study = list("Giletto")
),
tibble(
data = list("appendix_a"),
rows = list(c(56:60),c(61:64),c(65:69)),
n_rate = list(c("0","80","150","250")),
dap = list(c(45,60,75,90,110),c(55,61,83,110),c(47,62,75,91,105)),
year = list("2003-04","2004-05","2005-06"),
variety = list("Bannock Russet"),
location = list("Argentina"),
study = list("Giletto")
),
tibble(
data = list("appendix_a"),
rows = list(c(70:73),c(74:78)),
n_rate = list(c("0","80","150","250")),
dap = list(c(55,61,83,110),c(47,62,75,91,105)),
year = list("2004-05","2005-06"),
variety = list("Markies Russet"),
location = list("Argentina"),
study = list("Giletto")
),
tibble(
data = list("appendix_a"),
rows = list(c(4:8),c(9:12),c(13:17),c(18:22)),
n_rate = list(c("0","80","150","250")),
dap = list(c(45,60,75,90,110),c(55,61,83,110),c(47,62,75,91,105),c(45,58,74,95,116)),
year = list("2003-04","2004-05","2005-06","2006-07"),
variety = list("Innovator"),
location = list("Argentina"),
study = list("Giletto")
),
tibble(
data = list("appendix_b"),
rows = list(c(4:13),c(14:23),c(24:32),c(33:42)),
n_rate = list(c("0","50","100","250")),
dap = list(c(44,50,57,64,74,81,87,94,107,114),c(41,49,56,59,68,73,80,97,104,110),c(40,49,54,61,69,74,81,90,98),c(32,39,46,53,63,69,76,83,88,95)),
year = list("1900"),
variety = list("Shepody"),
location = list("Canada-Jacksonville","Canada-London","Canada-Hartland","Canada-Drummond"),
study = list("Giletto")
),
tibble(
data = list("appendix_b"),
rows = list(c(43:52),c(53:62),c(63:71),c(72:80)),
n_rate = list(c("0","50","100","250")),
dap = list(c(44,50,57,64,74,81,87,94,107,114),c(41,49,56,59,68,73,80,81,97,104),c(40,49,54,61,69,74,81,90,98),c(39,46,53,63,69,76,83,88,95)),
year = list("1900"),
variety = list("Russet Burbank"),
location = list("Canada-Jacksonville","Canada-London","Canada-Hartland","Canada-Drummond"),
study = list("Giletto")
)
)
}
get.list <- f.get.list()
d  <- pmap(list(get.list$data,
get.list$rows,
get.list$n_rate,
get.list$dap,
get.list$year,
get.list$variety,
get.list$location,
get.list$study),
~f.get(data = ..1,
rows = ..2,
n_rate = ..3,
dap = ..4,
year = ..5,
variety = ..6,
location = ..7,
study = ..8)) %>% bind_rows()
d <- d %>%
mutate(owner="Giletto") %>%
mutate(study=case_when(location == "Argentina" ~ "Giletto",
location == "Canada" ~ "Belanger",
T ~ NA_character_)) %>%
mutate(year=as.character(year(Date))) %>%
rename(date=Date) %>%
select(owner,study,year,location,variety,rate_n_kgha,date,W,N)
}
giletto <- f.giletto()
##### Combine and Format Data #####
data <- bind_rows(
bohman,
giletto
)
write_csv(data,"data.csv")
data <- read_csv("data.csv")
library(tidyverse)
library(brms)
data <- read_csv("data.csv")
data <- read_csv("data.csv",col_types="cccccdcdd")
data
d <- data %>%
filter(study%in%"Bohman") %>% #=="Bohman") %>% #
filter(location%in%"Minnesota") %>% #=="Minnesota") %>% #
filter(variety%in%"Russet Burbank") #=="Russet Burbank") #
d <- data %>%
filter(owner%in%"Bohman") %>% #=="Bohman") %>% #
filter(location%in%"Minnesota") %>% #=="Minnesota") %>% #
filter(variety%in%"Russet Burbank") #=="Russet Burbank") #
d
d %>%
ggplot(aes(x = W, y = N)) +
geom_point() +
facet_wrap(vars(Date))
d %>%
ggplot(aes(x = W, y = N)) +
geom_point() +
facet_wrap(vars(date))
d %>%
ggplot(aes(x = W, y = N)) +
geom_point() +
facet_wrap(vars(date,study))
formula_1 <- bf(W ~ fmin(Bmax + Si * (N - (alpha1*(Bmax^(-alpha2)))), Bmax),
Bmax + Si ~ 1 + (1|date/study), #(1|Date/year)
alpha1 + alpha2 ~ 1,
nl = T)
get_prior(formula_1, family = gaussian, data = d)
priors <- c(set_prior("normal(5,1)", nlpar = "alpha1", lb = 0, ub = 10),
set_prior("normal(0.5,0.1)", nlpar = "alpha2", lb = 0, ub = 1),
set_prior("normal(10,10)", nlpar = "Bmax", lb = 1, ub = 30),
set_prior("normal(6,1)", nlpar = "Si", lb = 0),
set_prior("cauchy(0,0.1)", class = "sd", nlpar = "Bmax"),
set_prior("cauchy(0,0.1)", class = "sd", nlpar = "Si"),
set_prior("normal(0,1)", class = "sigma", nlpar = ""))
m1 <- brm(formula_1, data = d, family = gaussian, prior = priors,
cores = 4, chains = 4, iter = 5000, warmup = 2000,
control = list(adapt_delta = 0.99, max_treedepth = 15))
formula_1 <- bf(W ~ fmin(Bmax + Si * (N - (alpha1*(Bmax^(-alpha2)))), Bmax),
Bmax + Si ~ (1|date), #(1|cor|Date),
alpha1 + alpha2 ~ 1,
nl = T)
get_prior(formula_1, family = gaussian, data = d)
priors <- c(set_prior("normal(5,1)", nlpar = "alpha1", lb = 0, ub = 10),
set_prior("normal(0.5,0.1)", nlpar = "alpha2", lb = 0, ub = 1),
set_prior("normal(10,10)", nlpar = "Bmax", lb = 1, ub = 30),
set_prior("normal(6,1)", nlpar = "Si", lb = 0),
set_prior("cauchy(0,0.1)", class = "sd", nlpar = "Bmax"),
set_prior("cauchy(0,0.1)", class = "sd", nlpar = "Si"))#,
m1 <- brm(formula_1, data = d, family = gaussian, prior = priors,
cores = 4, chains = 4, iter = 5000, warmup = 2000,
control = list(adapt_delta = 0.99, max_treedepth = 15))
m1
get_prior(formula_1, family = gaussian, data = d)
priors <- c(set_prior("normal(5,1)", nlpar = "alpha1", lb = 0, ub = 10),
set_prior("normal(0.5,0.1)", nlpar = "alpha2", lb = 0, ub = 1),
set_prior("normal(10,10)", nlpar = "Bmax", lb = 1, ub = 30),
set_prior("normal(6,1)", nlpar = "Si", lb = 0)) #,
m1 <- brm(formula_1, data = d, family = gaussian, prior = priors,
cores = 4, chains = 4, iter = 5000, warmup = 2000,
control = list(adapt_delta = 0.99, max_treedepth = 15))
d %>%
filter(W>=1)
filter_Date <- d %>%
group_by(Date) %>%
count() %>%
filter(n>=3) %>%
select(Date) %>%
pull()
d <- d %>%
filter(Date%in%filter_Date)
filter_Date <- d %>%
group_by(date) %>%
count() %>%
filter(n>=3) %>%
select(date) %>%
pull()
d <- data %>%
filter(owner%in%"Bohman") %>% #=="Bohman") %>% #
filter(location%in%"Minnesota") %>% #=="Minnesota") %>% #
filter(variety%in%"Russet Burbank") #=="Russet Burbank") #
d <- d %>%
filter(W>=1)
filter_Date <- d %>%
group_by(date) %>%
count() %>%
filter(n>=3) %>%
select(date) %>%
pull()
d <- d %>%
filter(Date%in%filter_Date)
library(tidyverse)
library(brms)
data <- read_csv("data.csv",col_types="cccccdcdd")
data
d <- data %>%
filter(owner%in%"Bohman") %>% #=="Bohman") %>% #
filter(location%in%"Minnesota") %>% #=="Minnesota") %>% #
filter(variety%in%"Russet Burbank") #=="Russet Burbank") #
# d <- d %>%
#   mutate(date = lubridate::ymd(Date),
#          year = lubridate::year(date))
d <- d %>%
filter(W>=1)
filter_date <- d %>%
group_by(date) %>%
count() %>%
filter(n>=3) %>%
select(date) %>%
pull()
d <- d %>%
filter(date%in%filter_Date)
d <- data %>%
filter(owner%in%"Bohman") %>% #=="Bohman") %>% #
filter(location%in%"Minnesota") %>% #=="Minnesota") %>% #
filter(variety%in%"Russet Burbank") #=="Russet Burbank") #
# d <- d %>%
#   mutate(date = lubridate::ymd(Date),
#          year = lubridate::year(date))
d <- d %>%
filter(W>=1)
filter_date <- d %>%
group_by(date) %>%
count() %>%
filter(n>=3) %>%
select(date) %>%
pull()
d <- d %>%
filter(date%in%filter_date)
d
d %>%
ggplot(aes(x = W, y = N)) +
geom_point() +
facet_wrap(vars(date,study))
d <- data %>%
filter(owner%in%"Bohman") %>% #=="Bohman") %>% #
filter(location%in%"Minnesota") %>% #=="Minnesota") %>% #
filter(variety%in%"Russet Burbank") #=="Russet Burbank") #
d
d %>%
filter(W>=1) %>%
na_rm()
d %>%
filter(W>=1)
d %>%
filter(W>=1) %>%
drop_na()
d <- data %>%
filter(owner%in%"Bohman") %>% #=="Bohman") %>% #
filter(location%in%"Minnesota") %>% #=="Minnesota") %>% #
filter(variety%in%"Russet Burbank") #=="Russet Burbank") #
d <- d %>%
filter(W>=1) %>%
drop_na()
filter_date <- d %>%
group_by(date) %>%
count() %>%
filter(n>=3) %>%
select(date) %>%
pull()
d <- d %>%
filter(date%in%filter_date)
d
d %>%
group_by(date) %>%
summarize_at(vars(W),sd)
d %>%
group_by(date) %>%
summarize_at(vars(W),funs(mean,sd))
d %>%
group_by(date) %>%
summarize_at(vars(W),list(mean,sd))
d %>%
group_by(date) %>%
summarize_at(vars(W),lst(mean,sd))
d %>%
group_by(date) %>%
summarize_at(vars(W),lst(mean,sd)) %>%
rowwise() %>%
mutate(cv=sd/mean) %>%
ungroup()
d %>%
ggplot(aes(x = W, y = N)) +
geom_point() +
facet_wrap(vars(date))
d.plot <- d %>%
ggplot(aes(x = W, y = N)) +
geom_point() +
facet_wrap(vars(date))
d.sum <- d %>%
group_by(date) %>%
summarize_at(vars(W),lst(mean,sd)) %>%
rowwise() %>%
mutate(cv=sd/mean) %>%
ungroup()
View(d.sum)
d.sum %>%
filter(sd>=0.5)
d.sum
d.sum %>%
filter(sd>=0.5) %>%
select(date) %>%
pull()
filter_sd <- d.sum %>%
filter(sd>=0.5) %>%
select(date) %>%
pull()
d %>%
filter(date%in%filter_sd)
d <- d %>%
filter(date%in%filter_sd)
formula_1 <- bf(W ~ fmin(Bmax + Si * (N - (alpha1*(Bmax^(-alpha2)))), Bmax),
Bmax + Si ~ (1|date), #(1|cor|Date),
alpha1 + alpha2 ~ 1,
nl = T)
get_prior(formula_1, family = gaussian, data = d)
priors <- c(set_prior("normal(5,1)", nlpar = "alpha1", lb = 0, ub = 10),
set_prior("normal(0.5,0.1)", nlpar = "alpha2", lb = 0, ub = 1),
set_prior("normal(10,10)", nlpar = "Bmax", lb = 1, ub = 30),
set_prior("normal(6,1)", nlpar = "Si", lb = 0)) #,
m1 <- brm(formula_1, data = d, family = gaussian, prior = priors,
cores = 4, chains = 4, iter = 5000, warmup = 2000,
control = list(adapt_delta = 0.99, max_treedepth = 15))
m1
d <- data %>%
filter(owner%in%"Bohman") %>% #=="Bohman") %>% #
filter(location%in%"Minnesota") %>% #=="Minnesota") %>% #
filter(variety%in%"Russet Burbank") #=="Russet Burbank") #
# d <- d %>%
#   mutate(date = lubridate::ymd(Date),
#          year = lubridate::year(date))
d <- d %>%
filter(W>=1) %>%
drop_na()
filter_date <- d %>%
group_by(date) %>%
count() %>%
filter(n>=3) %>%
select(date) %>%
pull()
d <- d %>%
filter(date%in%filter_date)
d
d.plot <- d %>%
ggplot(aes(x = W, y = N)) +
geom_point() +
facet_wrap(vars(date))
d.sum <- d %>%
group_by(date) %>%
summarize_at(vars(W),lst(mean,sd)) %>%
rowwise() %>%
mutate(cv=sd/mean) %>%
ungroup()
filter_sd <- d.sum %>%
filter(sd>=1.0) %>%
select(date) %>%
pull()
d <- d %>%
filter(date%in%filter_sd)
formula_1 <- bf(W ~ fmin(Bmax + Si * (N - (alpha1*(Bmax^(-alpha2)))), Bmax),
Bmax + Si ~ (1|date), #(1|cor|Date),
alpha1 + alpha2 ~ 1,
nl = T)
get_prior(formula_1, family = gaussian, data = d)
priors <- c(set_prior("normal(5,1)", nlpar = "alpha1", lb = 0, ub = 10),
set_prior("normal(0.5,0.1)", nlpar = "alpha2", lb = 0, ub = 1),
set_prior("normal(10,10)", nlpar = "Bmax", lb = 1, ub = 30),
set_prior("normal(6,1)", nlpar = "Si", lb = 0)) #,
m1 <- brm(formula_1, data = d, family = gaussian, prior = priors,
cores = 4, chains = 4, iter = 5000, warmup = 2000,
control = list(adapt_delta = 0.99, max_treedepth = 15))
m1
